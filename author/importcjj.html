<!doctype html>
<html lang="en">

<head>

    <title>Signal - Articles by importcjj</title>

    <!-- meta -->
    <meta charset="utf-8" />
    <meta name="author" content="importcjj" />
    <meta name="dc.language" content="en" />
    <meta name="dc.license" content="">

    <!-- favicon -->
    <link rel="icon" href="https://importcjj.github.io/theme/favicon.ico" type="image/x-icon">

    <!-- newsfeeds -->

    <!-- assets -->
    <!--[if lt IE 9]>
        <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
   
    <link href="https://fonts.googleapis.com/css?family=Linden+Hill:400,400italic" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Anonymous+Pro' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://importcjj.github.io/theme/css/simplegrid.css" type="text/css">
    <link rel="stylesheet" href="https://importcjj.github.io/theme/css/main.css" type="text/css">
    <link rel="stylesheet" href="https://importcjj.github.io/theme/css/pygments.css" type="text/css">
    <!--[if lt IE 8]>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet" type="text/css">
    <![endif]-->
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">

</head>

<body>

   <div class="grid grid-pad">
     <div class="col-1-1">        
       <ul id="mainnav">
          <li><a href="https://importcjj.github.io">home</a></li>
       </ul>
       <div id="blogtitle"><a href="https://importcjj.github.io">Signal</a></div>
       <div id="blogsubtitle"><a href="https://importcjj.github.io"></a></div>
     </div>
    </div>

    <div class="grid grid-pad">
       <div id="left-side" class="col-8-12">
          <section id="content" class="hyphenate">

        <article class="entry-overview">
            <div class="date">五 06 九月 2019 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/vscodehe-rust-nightlyde-jian-dan-pei-zhi.html" rel="bookmark" title="Permalink to Vscode和Rust nightly的简单配置">
                        Vscode和Rust nightly的简单配置
                    </a>
                </h2></header>

                   <div class="clearboth"><p>本人的常用IDE是小巧的vscode，之前写Rust的时候，使用的Rust版本是stable，vscode插件是Rust(rls)。一直以来工作良好，除了有时候rls会hanging。
最近要使用nightly版本的rust，vscode提示没有rls，然后选择安装，发现安装失败。于是就鼓捣了一番，决定将过程记录下来。</p>
<p><code>nightly</code>版本，顾名思义就是每晚构建的开发版本了。我以前安装nightly时的命令是</p>
<div class="highlight"><pre><span></span>rustup toolchain install nightly
</pre></div>


<p>这个命令呢会安装最新构建的nightly版本。</p>
<div class="highlight"><pre><span></span>rupst update
</pre></div>


<p>这个命令呢会更新安装的所有toolchain至最新。但是最新构建的nightly版本，既有可能还没有对于的rls组件，这样的话在IDE里就没法好好开发了，毕竟在rust里，编译器是
程序员的爹。没有rls，就会像失去了眼睛一样难受。搜寻了一番，找到一个地址，通过网页可以快捷的知道对于平台的nightly版本，其对于组件的发布情况如何。如果你们以后发现
自己的rust没有对于的rls，就可以检查下是不是nightly太新了，如果是的话，就需要安装前几个版本的nightly了。</p>
<p>https://rust-lang.github.io/rustup-components-history/x86_64-apple-darwin.html</p>
<p>如何安装指定版本的nightly呢？</p>
<div class="highlight"><pre><span></span>rustup toolchain install nightly-<span class="o">[</span>year<span class="o">]</span>-<span class="o">[</span>month<span class="o">]</span>-<span class="o">[</span>day<span class="o">]</span>
// 比如 nightly-2019-09-05，因为这个版本目前有rls
rustup default nightly-<span class="o">[</span>year<span class="o">]</span>-<span class="o">[</span>month<span class="o">]</span>-<span class="o">[</span>day<span class="o">]</span>
rustup component add rls
</pre></div>


<p>我使用的rust插件，会主动提示选择toolchain，如果选择的toolchain没有安装需要的开发组件的话，也会提示安装。如果组件本身没有缺失的话，就可以安装成功！</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/rust.html">#rust</a> and                             <a href="https://importcjj.github.io/tag/vscode.html">#vscode</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">五 06 九月 2019 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/rustfan-xu-lie-jsonde-xiao-ji-qiao.html" rel="bookmark" title="Permalink to Rust反序列JSON的小技巧">
                        Rust反序列JSON的小技巧
                    </a>
                </h2></header>

                   <div class="clearboth"><p>serde是Rust中最流行的序列化和反序列化crate，这一篇就来记录下如何使用serde_json来反序列化连续的json对象。</p>
<p>比如有这样一段json数据:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;start_pos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nt">&quot;end_pos&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}{</span><span class="nt">&quot;start_pos&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nt">&quot;end_pos&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;start_pos&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="nt">&quot;end_pos&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">}</span>
</pre></div>


<p>这段数据中，是三个连续的字段相同json对象，那么如何对这多个数据进行反序列化呢？</p>
<div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">Deserializer</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Deserialize, Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Index</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">start_pos</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">end_pos</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="err">#</span><span class="s">&quot;</span>
<span class="s">    {&quot;</span><span class="n">start_pos</span><span class="s">&quot;: 0, &quot;</span><span class="n">end_pos</span><span class="s">&quot;: 10}{&quot;</span><span class="n">start_pos</span><span class="s">&quot;: 10, &quot;</span><span class="n">end_pos</span><span class="s">&quot;: 30}</span>
<span class="s">    {&quot;</span><span class="n">start_pos</span><span class="s">&quot;: 30, &quot;</span><span class="n">end_pos</span><span class="s">&quot;: 40}</span>
<span class="s">    &quot;</span><span class="err">#</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Deserializer</span>::<span class="n">from_str</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">into_iter</span>::<span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indices</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;offset {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">.</span><span class="n">byte_offset</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;idx =&gt; {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Deserializer对象还有一个方法<code>from_reader</code>支持从文件对象中读取数据。</p>
<p>完结撒花！</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/json.html">#json</a>,                             <a href="https://importcjj.github.io/tag/rust.html">#rust</a> and                             <a href="https://importcjj.github.io/tag/serde.html">#serde</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">四 05 九月 2019 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/rustde-macroxiao-ji-yi.html" rel="bookmark" title="Permalink to Rust的macro小记(一)">
                        Rust的macro小记(一)
                    </a>
                </h2></header>

                   <div class="clearboth"><p>这篇记录一下Rust中的Function-like macros，也就是形如println!(...)形式的宏。</p>
<p>先来一个简单的</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>上面这个简单的例子中， 定义了一个叫做hello的宏，匹配规则为空。作用就是在使用该宏的地方，插入代码<code>println!("Hello, World!");</code>。
接下来我们加入匹配规则，来让这个宏更加的灵活.</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$name</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="cp">$name</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;rust&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>现在增加了一个匹配规则，这样编译器在在工作时会按规则匹配，使用不同的代码分支。那可不可以让<code>hello</code>支持多个参数呢?
当然可以！宏的匹配规则支持重复模式!</p>
<ul>
<li><code>*</code> 模式重复零次或多次</li>
<li><code>+</code> 模式重复一次或多次</li>
<li><code>?</code> 模式出现零次或一次</li>
</ul>
<p>让我们来稍加改造一下:</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($name</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">$(</span><span class="w"></span>
<span class="w">            </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span><span class="w"> </span><span class="cp">$name</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;rust&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">hello</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;rust&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;macro&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>这下我们可以让<code>hello</code>接收多个参数了, 每个参数都会被展开成一句<code>print!</code>代码。如果你观察仔细的话，会发现我们在定义模式的时候有一个逗号，但是使用的参数<code>macro</code>后面没有逗号，但是规则却能正常匹配，超级方便有木有！</p>
<p>到目前为止，我们使用的方式还是停留在函数调用的形式，接下来来一个复杂一点的例子。我相信很多人都接触过rpc，那么接下来就来定义我们自己的rpc client。</p>
<p>首先我们确定我们想要的形式</p>
<div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Ping</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>


<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Pong</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="n">service</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">service</span><span class="w"> </span><span class="n">demo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rpc</span><span class="w"> </span><span class="n">ping</span><span class="p">(</span><span class="n">Ping</span><span class="p">)</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="n">Pong</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span>::<span class="n">demo</span>::<span class="p">{</span><span class="n">Client</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">rsp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">ping</span><span class="p">(</span><span class="n">Ping</span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">Pong</span><span class="p">{});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>好，我们已经知道想要的形式了，接下来就让我们实现我们的<code>service</code>宏吧!</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">service</span><span class="w"> </span><span class="cp">$srv_name</span>:<span class="nc">ident</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="n">rpc</span><span class="w"> </span><span class="cp">$method_name</span>:<span class="nc">ident</span><span class="p">(</span><span class="cp">$input</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="cp">$output</span>:<span class="nc">tt</span><span class="p">);)</span><span class="o">*</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>这部分我们定义了宏的<code>rule</code>， 可以看到是对应我们之前提出的使用形式的。而且，再规则的内层使用重复的形式允许我们定义多个rpc方法。在这里给出参数的含义</p>
<ul>
<li>$srv_name: service的名称</li>
<li>$method_name: rpc方法的名称</li>
<li>$input: rpc方法的输入参数</li>
<li>$output: rpc方法的输出结果</li>
</ul>
<p>然后，我们来定义宏的输出部分</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">service</span><span class="w"> </span><span class="cp">$srv_name</span>:<span class="nc">ident</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="n">rpc</span><span class="w"> </span><span class="cp">$method_name</span>:<span class="nc">ident</span><span class="p">(</span><span class="cp">$input</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="cp">$output</span>:<span class="nc">tt</span><span class="p">);)</span><span class="o">*</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="cp">$srv_name</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="cp">$input</span><span class="p">;)</span><span class="o">*</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="cp">$output</span><span class="p">;)</span><span class="o">*</span><span class="w"></span>


<span class="w">            </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Client</span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">impl</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Client</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="cp">$(</span><span class="w"></span>
<span class="w">                    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="cp">$method_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_input</span>: <span class="cp">$input</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="cp">$output</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>到了这里，基本完成了输出部分的主体代码。现在遇到了一个问题，就是如何实现结果的返回呢。在实际使用中，client会接收的远程服务返回的字节数据，然后使用特定的protocol来完成结果的解码，所以我们的输入输出类型均要实现解码编码的功能，由于例子的ping方法简单，所以只在这里为方法的返回类型pong实现一个简易的解码函数.</p>
<div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">decode</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Pong</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Pong</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">decode</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Pong</span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>我们定义了一个trait <code>Message</code>, 目前只有一个decode方法。这里的decode方法简化了参数， 正常情况下会输入字节数据进行反序列化。然后，我们又为<code>Pong</code>实现了<code>Message</code>。接下来就是使用它们的时候了。</p>
<div class="highlight"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">service</span><span class="w"> </span><span class="cp">$srv_name</span>:<span class="nc">ident</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="n">rpc</span><span class="w"> </span><span class="cp">$method_name</span>:<span class="nc">ident</span><span class="p">(</span><span class="cp">$input</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="n">returns</span><span class="w"> </span><span class="p">(</span><span class="cp">$output</span>:<span class="nc">tt</span><span class="p">);)</span><span class="o">*</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="cp">$srv_name</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// 引入Message</span>
<span class="w">            </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">Message</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="cp">$input</span><span class="p">;)</span><span class="o">*</span><span class="w"></span>
<span class="w">            </span><span class="cp">$(</span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="cp">$output</span><span class="p">;)</span><span class="o">*</span><span class="w"></span>


<span class="w">            </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Client</span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="k">impl</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">Client</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="cp">$(</span><span class="w"></span>
<span class="w">                    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="cp">$method_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_input</span>: <span class="cp">$input</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="cp">$output</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// TODO call the remote server</span>
<span class="w">                        </span><span class="cp">$output</span>::<span class="n">decode</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>友情提示，可以使用cargo的小工具<code>expand</code>展开宏代码，得到</p>
<div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">demo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">Message</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">Ping</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="n">Pong</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Client</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ping</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_input</span>: <span class="nc">Ping</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pong</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Pong</span>::<span class="n">decode</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>终于顺利完成啦!</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/rust.html">#rust</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">三 04 九月 2019 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/rustshi-yong-matchde-xiao-fa-xian.html" rel="bookmark" title="Permalink to Rust使用match的小发现">
                        Rust使用match的小发现
                    </a>
                </h2></header>

                   <div class="clearboth"><p>今天在读一个库的代码时候，发现了之前使用match的时候没有注意的一个地方。</p>
<div class="highlight"><pre><span></span><span class="k">enum</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">One</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Two</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Three</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span>::<span class="n">One</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Foo</span>::<span class="n">One</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;It&#39;s one&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">others</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;It&#39;s others&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>这里没有使用<code>_</code>去匹配其他分支，而是随意指定了一个名字<code>others</code>。貌似对可读性有一定提升。</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/rust.html">#rust</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">一 16 一月 2017 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/golangjie-kou-xing-han-shu.html" rel="bookmark" title="Permalink to Golang接口型函数">
                        Golang接口型函数
                    </a>
                </h2></header>

                   <div class="clearboth"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Do</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">Do</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">Each</span><span class="p">(</span><span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{},</span> <span class="nx">h</span> <span class="nx">Handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span> <span class="p">{</span>
        <span class="nx">h</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">EachFunc</span><span class="p">(</span><span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{},</span> <span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{}))</span> <span class="p">{</span>
    <span class="nx">Each</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">SayHello</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Hello, I am %s, %d years old!\n&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">students</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nx">students</span><span class="p">[</span><span class="s">&quot;Marry&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">20</span>
    <span class="nx">students</span><span class="p">[</span><span class="s">&quot;Tom&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">23</span>
    <span class="nx">EachFunc</span><span class="p">(</span><span class="nx">students</span><span class="p">,</span> <span class="nx">SayHello</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/go.html">#Go</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">一 20 六月 2016 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/gowang-luo-bian-cheng-ji-lei-yi.html" rel="bookmark" title="Permalink to go网络编程积累(一)">
                        go网络编程积累(一)
                    </a>
                </h2></header>

                   <div class="clearboth"><div class="highlight"><pre><span></span><span class="c1">//server.go</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;io&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8888&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Can&#39;t listen&quot;</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Can&#39;t accept a conn&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">go</span> <span class="nx">handleConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">handleConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Conn was closed.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">//client.go</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8888&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="nx">buf</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;Hello, my server&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Write %s to conn&quot;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>最近在看unix网络编程这本书，顺便结合go来试试手。在写完这个简单的客户端服务器程序后，发现了几个以前一直没注意的问题。</p>
<h4>发现一: Reader.Read</h4>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">Reader</span><span class="p">)</span> <span class="nx">Read</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Reader</span><span class="p">)</span> <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="nx">Read</span> <span class="nx">reads</span> <span class="nx">data</span> <span class="nx">into</span> <span class="nx">p</span><span class="p">.</span> <span class="nx">It</span> <span class="nx">returns</span> <span class="nx">the</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">bytes</span>
<span class="nx">read</span> <span class="nx">into</span> <span class="nx">p</span><span class="p">.</span> <span class="nx">It</span> <span class="nx">calls</span> <span class="nx">Read</span> <span class="nx">at</span> <span class="nx">most</span> <span class="nx">once</span> <span class="nx">on</span> <span class="nx">the</span> <span class="nx">underlying</span> 
<span class="nx">Reader</span><span class="p">,</span> <span class="nx">hence</span> <span class="nx">n</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">less</span> <span class="nx">than</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span> <span class="nx">At</span> <span class="nx">EOF</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">count</span> 
<span class="nx">will</span> <span class="nx">be</span> <span class="nx">zero</span> <span class="nx">and</span> <span class="nx">err</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">.</span>
</pre></div>


<p>将数据读取到提供的byte切片p中，读取的数据量与p的长度有关。这一点以前一直没有注意到，以致于程序一直有问题。以前我一直这样使用:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>由于buf在声明之后没有分配内存，所以一直是nil，因此len(buf)当然也是0，所以在Read数据的时候，返回的n一直都是0，这导致了无法正常显示客户端发送的数据。正确的用法是在Read之前先使用make为buf分配一定长度的空间：</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
<span class="p">}</span>
</pre></div>


<p>上述例子中，首先为buf分配了30*1024字节的内存空间。这样就能正常读取连接中的数据了。n总是小于等于len(buf)。当EOF时，Read返回0和一个io.EOF错误，表示无法读取更多的数据。另外，如果返回了io.EOF以外的错误，则表示还没读取完全之前就遇到了某个错误。</p>
<h4>发现二：判断是否实现了特定接口</h4>
<p>在go中，无需显式声明自己实现了某个接口。如果类型实现了某个接口定义的全部方法，则该类型实现了该接口。在某些特定的时候，我们需要在代码逻辑中判断接口的实现。如果实现了某接口，还需要调用该接口中的方法。</p>
<div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Reader</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">conn</span> <span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8080&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">rd</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.(</span><span class="nx">Reader</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="nx">n</span> <span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rd</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h4>发现三：defer应该在error判断之后</h4>
<p>使用defer的时候经常会写出以下代码</p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:8080&quot;</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>    
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>这样写保证了函数main函数执行退出时必定能关闭tcp连接。但是在没有建立正常连接时，conn为nil，并没有实现Closer接口，也就没有Close方法可供调用，这样的代码就会引发panic。</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/web.html">#web</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">三 18 五月 2016 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/greenlet-qing-liang-ji-bing-fa-bian-cheng.html" rel="bookmark" title="Permalink to Greenlet: 轻量级并发编程">
                        Greenlet: 轻量级并发编程
                    </a>
                </h2></header>

                   <div class="clearboth"><h4>动机</h4>
<p>greenlet这个包拆分自Stackless。Stackless是一个CPython的版本，实现并支持一种叫做tasklets的微线程。Tasklets会以一种伪并发的方式运行(通常运行在单个或者一些系统级的线程中)，它们之间通过channels来同步数据。</p>
<p>一个greenlet，从另一方面来说，依然是一种很原始的没有隐式调度的微线程。换句话说，就是协程(coroutine)。这在你想要完全控制代码的运行时是非常有用的。你可以在greenlet之上构建采用自定义调度方式的微线程。然而，使用greenlet来制作先进的控制流结构是很有用的。举个例子，我们可以重新创造生成器。和Python自带的生成器所不同的是，我们的生成器可以调用网状的方法，而且这些网状的方法也可以yield出值。(另外，你不需要再使用<strong>yield</strong>这个关键词了）</p>
<h4>举例</h4>
<p>我们来思考一个程序，用户可以在一个类终端控制台中输入命令来控制该程序。假设命令是一个字符一个字符的输入。在这样一个系统中，通常会存在如下一个循环:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_commands</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">read_next_char</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;quit</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;are you sure?&quot;</span>
            <span class="k">if</span> <span class="n">read_next_char</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">continue</span>    <span class="c1"># ignore the command</span>
        <span class="n">process_command</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>


<p>如果现在假设你想要将这个程序插入到用户界面中。大部分的用户界面工具都是基于事件驱动的，它们会在用户输入一个字符后调用回调函数。在这种设定下，编写上述代码所需的read_next_char()函数是非常难的，将会有如下两个冲突的函数:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">event_keyworn</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="err">??</span>

<span class="k">def</span> <span class="nf">read_next_char</span><span class="p">():</span>
    <span class="err">??应该等待下一个</span><span class="n">event_keydown</span><span class="p">()</span><span class="err">函数的调用</span>
</pre></div>


<p>显然，上述情况在串行运行是不可能的。你也许想到了使用多个线程来完成。使用Greenlets作为替代方法，可以免去关联锁和程序退出的相关问题。你可以在程序运行主干中分裂出一个greenlet来专门运行process_commands()函数，你可以使用如下方式来交换用户的按键情况：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">event_keydown</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="c1"># 跳转至g_processor, 并且把用户所按键发送给g_processor</span>
    <span class="n">g_processor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_commands</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">read_next_char</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;quit</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;are you sure?&quot;</span>
            <span class="k">if</span> <span class="n">read_next_char</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">continue</span>    <span class="c1"># ignore the command</span>
        <span class="n">process_command</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_next_char</span><span class="p">():</span>
    <span class="c1"># 在这个例子里，g_self就是g_processor</span>
    <span class="n">g_self</span> <span class="o">=</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">getcurrent</span><span class="p">()</span>
    <span class="c1"># 跳转到父greenlet(主greenlet)中，等待下一个按键</span>
    <span class="n">next_char</span> <span class="o">=</span> <span class="n">g_self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">next_char</span>

<span class="n">g_processor</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">process_commands</span><span class="p">)</span>
<span class="n">g_processor</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>   <span class="c1"># input arguments to process_commands()</span>

<span class="n">gui</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>


<p>在这个例子中，执行过程如下: 当read_next_char()被调用时，身处于g_processor这个greenlet中，所以它的父greenlet也就是派生g_processor的根greenlet。当它显示切换回父greenlet的时候，程序会重新回到顶层继续GUI事件监听循环。当事件监听循环回调event_keydown()函数的时候, 又切换回g_processor，这意味着程序会跳转到目标greenlet之前被挂起的地方继续执行-在这个例子里，将会跳转会read_next_char()函数中调用switch()的地方继续执行，并且在event_keydown()中调用switch()时所给的参数key会被做为返回值，并赋值给变量next_char。</p>
<p>注意，read_next_char()函数在被挂起和恢复时，它的调用栈会得到保护。所以它会在process_commands()中的不同位置返回，这主要取决于它原先被调用的位置。这使程序的执行逻辑以一种很好的控制流得以保持。我们不需要完全重写process_commands()来使其转化为状态机。</p>
<h4>使用</h4>
<h5>简介</h5>
<p>一个greenlet其实是一个独立的微伪线程。把它想象成一个小型的frame栈。最外层的frame就是你调用的初始函数，最里层的frame就是greenlet目前正停留的frame。在你使用greenlets的时候，就是通过创建大量的这种栈，并且在它们之间跳跃执行。跳跃(切换)永远都是显式的。一个greenlet必须显式切换至目标greenlet，这样会使前者的执行被挂起，而目标greenlet会在之前挂起的地方被恢复过来继续执行。greenlets之间的跳跃被称为<strong>切换</strong>。</p>
<p>当你创建了一个greenlet，它会的到一个初始的空栈；当第一次切换到这个greenlet的时候，它开始执行一个指定的函数，在这个函数中又可能会调用其他函数，切换至其他greenlet。最终当最外层的函数执行完毕后，整个greenlet的调用栈再次变空，那么这个greenlet就死了。greenlet也可能死于未被捕获的异常。</p>
<p>举个例子:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">test1</span><span class="p">():</span>
    <span class="k">print</span> <span class="mi">12</span>
    <span class="n">gr2</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="mi">34</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="k">print</span> <span class="mi">56</span>
    <span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="mi">78</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test1</span><span class="p">)</span>
<span class="n">gr2</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test2</span><span class="p">)</span>
<span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
</pre></div>


<p>最后一行跳转至函数test1，打印出12。又跳转至函数test2，打印了56。重新跳转会test1，打印了34。 然后test1所在的greenlet执行完成并且死亡。此时，程序回到最开始的gr1.switch()继续执行。注意，78将永远不会被执行。</p>
<h4>父级</h4>
<p>让我们看看当某个greenlet死亡的的时候，程序会如何执行。每一个greenlet都会有一个父greenlet。顾名思义，父greenlet就是分裂出子greenlet的greenlet(不过可以随时通过greenlet.parent来修改某一个greenlet的父greenlet)。当greenlet结束的时候，程序会回到他的父greenlet继续执行。这样，所有的greenlet形成树结构。树的根节点其实是隐式的<strong>主greenlet</strong>，所以不在用户自定义的greenlet中执行的代码都会在主greenlet中被执行。</p>
<p>在上面的例子中，gr1和gr2的父greenlet都是最外层的主greenlet，不论是它们中谁结束了，程序就会回到主greenlet继续执行。</p>
<p>greenlet未被捕获的异常也会往外抛给父级greenlet。举个例子，如果上面例子中的函数test2包含一个拼写错误，那么所产生的<strong>NameError</strong>异常会干死gr2，程序便会直接回到主greenlet执行。而traceback会包含test2，但不会包含test1。记住，switch不是调用，而是在多个并行的栈容器之间切换执行。父级表示了它的栈在逻辑上是在当前greenlet的下方的。</p>
<h4>实例</h4>
<p><code>greenlet.greenlet</code>是greenlet类型， 它支持以下操作:</p>
<p><code>greenlet(run=None, parent=None)</code>
创建新的greenlet对象(不会运行)。<code>run</code>参数执行需要执行的函数，<code>parent</code>指定它的父级greenlet，默任的话就是当前的greenlet。</p>
<p><code>greenlet.getcurrent()</code>
返回当前所在的greenlet（即调用该函数的greenlet)</p>
<p><code>greenlet.GreenletExit</code>
这个特定的异常并不会被往外抛给其父级greenlet；使用它可以杀死一个greenlet。</p>
<p><code>greenlet</code>类也可以被继承。greenlet的run属性一般是在greenlet创建时被设置，调用<code>run</code>可以启动该greenlet。但当你定义greenlet的子类时，重写其<code>run</code>方法比在构造函数中传入<code>run</code>参数来的有意义。</p>
<h4>切换</h4>
<p>greenlet之间的切换发生在某个greenlet的switch函数被调用的时候，亦或是某个greenlet结束的时候(程序会返回父级greenlet继续执行)。在切换期间，一个对象或异常会被发送给目标greenlet。这可以作为一种方便的方法在greenlet之间传递信息。比如:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">gr2</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">u</span>
    <span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test1</span><span class="p">)</span>
<span class="n">gr2</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test2</span><span class="p">)</span>
<span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot; world&quot;</span><span class="p">)</span>
</pre></div>


<p>上述程序将会打印"hello, world"和42。值的注意的是，函数test1和函数test2的参数不是在greenlet被创建时所提供，而是在第一次切换到它们执行时提供。</p>
<p><code>g.switch(*args, **kwargs)</code>
将执行权切换给greenlet <strong>g</strong>, 并将指定参数发送给它。特别的是，如果g还没有启动，那么此时g将会启动。</p>
<p><strong>greenlet之死</strong>
如果greenlet的run函数执行完了，函数的返回值将会被发送给其父级。如果run函数被异常所终止，则异常也会被抛给其父级(除非是greenlet.GreenletExit异常，该异常会被捕获，函数执行结束并返回父级)。</p>
<p>除了上述之外，目标greenlet通常接收对象作为调用之前已被挂起的greenlet的switch()函数的返回值。实际上，尽管对于switch()函数的调用不会立即返回，但是仍然会在未来的某个时刻返回(可能是别的greenlet切换时给出的参数，也可能是之前switch的greenlet的函数返回值)。此时，程序会回到之前被挂起的位于对于switch()函数的调用处。这表示 x = g.switch(y) 会把y发送给greenlet <strong>g</strong>，然后过段时间之后，会接收到一个对象并赋值给x。</p>
<p>注意，对于任何已死greenlet的切换操作都会走到它们的父辈，或者父父辈，以此类推。最后的父级greenlet就是整棵树的根节点<strong>main</strong>greenlet，因为它永远不会死亡。</p>
<h4>greenlet的属性和方法</h4>
<p><code>g.switch(*args, **kwargs)</code>
切换至greenlet <strong>g</strong>。</p>
<p><code>g.run</code>
greenlet启动时将会执行的函数。当greenlet <strong>g</strong> 启动后该属性将不复存在。</p>
<p><code>g.parent</code>
父级greenlet。该属性可修改，但是不允许形成循环父子结构。</p>
<p><code>g.gr_frame</code>
The current top frame, or None.
当前顶层frame，没有则是None。</p>
<p><code>g.dead</code>
如果greenlet <strong>g</strong>已经执行结束了，则返回True。</p>
<p><code>bool(g)</code>
如果greenlet <strong>g</strong>还活着，则返回True，结束活着还未开始都是False。</p>
<p><code>g.throw([typ, [val, [tb]]])</code>
切换至greenlet <strong>g</strong>，不过会立刻在g中抛出给定的异常。如果没有指定任何参数，那么默认抛出<code>greenlet.GreenletExit</code>，那么g就结束了。调用这个函数就相当于下面的过程:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">raiser</span><span class="p">():</span>
    <span class="k">raise</span> <span class="n">typ</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span>
<span class="n">g_raiser</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">raiser</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">g_raiser</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
</pre></div>


<p>注意，上述代码对于<code>greenlet.GreenletExit</code>无效，因为该异常不会被抛给父级greenlet <strong>g</strong>。</p>
<h4>greenlets和Python线程</h4>
<p>greenlet可以和Python的线程结合使用；这种情况下，每一个线程将包含一个主greenlet和大量子greenlet，形成树形结构。对于属于不同线程的greenlets，混合或者切换操作是不可能的。</p>
<h4>greenlet的垃圾回收</h4>
<p>如果对于一个greenlet对象的所有引用都不存在了(包括来自其他greenlet的parent属性的引用)，然后就没有办法再切换到这个greenlet了。这种情况下，<code>GreenletExit</code>异常就会在该greenlet中产生，这是一个greenlet唯一的一种异步获取执行权的情况。你可以使用<code>try:finally:</code>语句块来清理该greenlet所占有的资源。这个特性同时也支持那种使用死循环接收并处理数据的编码风格。当对于greenlet的最后一个引用被干掉后，死循环就会自动终止了。</p>
<p>通过在某处保存对于某个greenlet的新引用可以认为这个greenlet可以正常死亡或重新恢复。只要捕获并忽略<code>GreenletExit</code>异常就可以让这个greenlet进入死循环。</p>
<p>Greenlet不参与垃圾回收；greenlet中的循环引用将不会被发现，循环保存对于greenlet的引用可能会导致内存泄露。</p>
<h4>调用跟踪支持</h4>
<p>标准的Python调用跟踪和性能分析在greenlet中不能正常工作，这是因为栈和frame的切换发生在同一个线程之中。使用传统的方法来发现可靠的greenlet切换操作是很困难的，所以greenlet模块为基于greenlet的代码提供了新的调试，追踪和分析功能:</p>
<p><code>greenlet.gettrace()</code>
返回先前设定的调用跟踪函数，如果没有则返回None。</p>
<p><code>greenlet.settrace(callback)</code>
设定新的调用跟踪函数并返回之前设定的调用跟踪函数，如果没有则返回None。回调函数会被不同的事件所调用，并且需要行如：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># Handle a switch from origin to target.</span>
        <span class="c1"># Note that callback is running in the context of target</span>
        <span class="c1"># greenlet and any exceptions will be passed as if</span>
        <span class="c1"># target.throw() was used instead of a switch.</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;throw&#39;</span><span class="p">:</span>
        <span class="n">origin</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># Handle a throw from origin to target.</span>
        <span class="c1"># Note that callback is running in the context of target</span>
        <span class="c1"># greenlet and any exceptions will replace the original, as</span>
        <span class="c1"># if target.throw() was used with the replacing exception.</span>
        <span class="k">return</span>
</pre></div>


<p>如果事件类型既有<strong>'switch'</strong>又有<strong>'throw'</strong>, 那么对于参数元组args的解包就非常重要。这样的话，API就可以像<code>sys.settrace()</code>那样被扩展为更多的事件类型。</p>
<h4>两个官方给出的例子</h4>
<h5>1. 简单的生成器</h5>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>


<span class="k">class</span> <span class="nc">genlet</span><span class="p">(</span><span class="n">greenlet</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwds</span> <span class="o">=</span> <span class="n">kwds</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
        <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">getcurrent</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c1"># Hack: Python &lt; 2.6 compatibility</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">__next__</span>


<span class="k">def</span> <span class="nf">Yield</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">getcurrent</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">genlet</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;yield outside a genlet&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">generator</span><span class="p">(</span><span class="n">genlet</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">generator</span>


<span class="k">class</span> <span class="nc">GeneratorTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">Yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">g</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>


<h5>2. 网状调用生成器</h5>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>


<span class="k">class</span> <span class="nc">genlet</span><span class="p">(</span><span class="n">greenlet</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwds</span> <span class="o">=</span> <span class="n">kwds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
        <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child</span>
            <span class="k">while</span> <span class="n">child</span><span class="o">.</span><span class="n">child</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">child</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">child</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">getcurrent</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c1"># Hack: Python &lt; 2.6 compatibility</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">__next__</span>


<span class="k">def</span> <span class="nf">Yield</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">greenlet</span><span class="o">.</span><span class="n">getcurrent</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">genlet</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;yield outside a genlet&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">set_child</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">g</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Genlet</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Genlet</span><span class="p">(</span><span class="n">genlet</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">Genlet</span>


<span class="k">def</span> <span class="nf">g1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">g2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">g2</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nested</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">Yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">g3</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nested</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">g3</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">g3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Yield</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">Yield</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">perms</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="c1"># No syntactical sugar for generator expressions</span>
            <span class="p">[</span><span class="n">Yield</span><span class="p">([</span><span class="n">e</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">e</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Yield</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="n">perms</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">perms</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gr1</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">Yield</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">Yield</span><span class="p">(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">gr1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gr2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">gr1</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

<span class="n">gr2</span> <span class="o">=</span> <span class="n">Genlet</span><span class="p">(</span><span class="n">gr2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NestedGeneratorTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_layered_genlets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">gr2</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_permutations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gen_perms</span> <span class="o">=</span> <span class="n">perms</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
        <span class="n">permutations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gen_perms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permutations</span><span class="p">),</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">perms</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))),</span> <span class="n">perms</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)))):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="p">[([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
             <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
             <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])])</span>
        <span class="c1"># XXX Test to make sure we are working as a generator expression</span>

    <span class="k">def</span> <span class="nf">test_genlet_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g3</span><span class="p">]:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">g</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_genlet_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Yield</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_nested_genlets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
</pre></div>


<h4>结尾</h4>
<p>了解greenlet主要是为了深入了解gevent做铺垫，翻译呢主要是为了加深自己的记忆：）</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/concurrent.html">#concurrent</a> and                             <a href="https://importcjj.github.io/tag/gevent.html">#gevent</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">二 10 五月 2016 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/golangbian-cheng-lian-xi.html" rel="bookmark" title="Permalink to Golang编程练习">
                        Golang编程练习
                    </a>
                </h2></header>

                   <div class="clearboth"><p>完整代码 <a href="https://github.com/importcjj/fooutils">戳这里</a></p>
<h5>1. 验证给定字符串是否为合法身份证号码</h5>
<p>算法：前17位纯数字分别乘以相应的因子，然后求和后除以11取余数。使用该余数取得校验字节数组中相位位置的字节与身份证最后一位字节做比较。如果相等即为合法身份证！</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kn">import</span> <span class="s">&quot;strconv&quot;</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">Factories</span>    <span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="kt">int</span> <span class="p">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
    <span class="nx">ValidateBits</span> <span class="p">[]</span><span class="kt">byte</span>  <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;10X98765432&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">IsValidIDCode</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">idBytes</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">length</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">idBytes</span><span class="p">);</span> <span class="nx">length</span> <span class="o">!=</span> <span class="mi">18</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="nx">sum</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="nx">lastByte</span> <span class="o">:=</span> <span class="nx">idBytes</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span>
    <span class="nx">idBytes</span> <span class="p">=</span> <span class="nx">idBytes</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>

    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">idBytes</span> <span class="p">{</span>
        <span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">*</span> <span class="nx">Factories</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nx">index</span> <span class="o">:=</span> <span class="nx">sum</span> <span class="o">%</span> <span class="mi">11</span>
    <span class="k">if</span> <span class="nx">ValidateBits</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">==</span> <span class="nx">lastByte</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">myID</span> <span class="o">:=</span> <span class="s">&quot;身份证号码&quot;</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">IsValidIDCode</span><span class="p">(</span><span class="nx">myID</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>


<h5>2. 排序之快速排序</h5>
<p>快速排序的本质其实很简单: 在一趟排序中，在需要排序的序列中选出一个基准数(pivot), 然后将比它的数放左边， 比它小的放右边。然后采用分治和递归，再去分别对小数序列和大数序列排序。</p>
<p>以前学的一种实现使用while循环，老是在right, left等于的时候搞不清楚啊。在参考了wiki百科之后，发现以下写法清晰易懂。
允许随便选取一个基准（不过我写的时候，默认使用第一位了), 先把基准放置到最后一位，然后遍历前n-1个数，把小于基准数的数往前放，同时使用一个游标来记录。遍历完之后，将基准数交换到游标处。自此，基准数之前全是小于基准数的，之后都是小于等于基本数的。然后分别继续递归。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>

    <span class="nx">IntQuickSort</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
<span class="p">}</span>



<span class="kd">func</span> <span class="nx">IntQuickSort</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// 默认将第一位作为基准位</span>
    <span class="nx">pivotIndex</span> <span class="o">:=</span> <span class="nx">left</span>

    <span class="c1">// 把基准交换到最后一位</span>
    <span class="nx">slice</span><span class="p">[</span><span class="nx">pivotIndex</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">right</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">right</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">pivotIndex</span><span class="p">]</span>

    <span class="nx">storeIndex</span> <span class="o">:=</span> <span class="nx">left</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">left</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">right</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">right</span><span class="p">]</span> <span class="p">{</span>
            <span class="nx">slice</span><span class="p">[</span><span class="nx">storeIndex</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">storeIndex</span><span class="p">]</span>
            <span class="nx">storeIndex</span> <span class="o">++</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">slice</span><span class="p">[</span><span class="nx">storeIndex</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">right</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">right</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">storeIndex</span><span class="p">]</span>

    <span class="nx">IntQuickSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">storeIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">IntQuickSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">storeIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h5>3. 排序之归并排序</h5>
<p><img alt="merge sort" src="https://7xsw69.com1.z0.glb.clouddn.com/Merge-sort-example-300px.gif" /></p>
<p>上图非常清楚的表现了归并排序的过程: 先不停的对半分组，直到分成一个数字一组， 然后相邻的两组作比较，归并成有序的一组，不断向上归并。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">IntMergeSort</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">left</span> <span class="o">&gt;=</span> <span class="nx">right</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">cache</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice</span><span class="p">))</span>
    <span class="nx">intMergeSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">intMergeSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">cache</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">length</span> <span class="o">:=</span> <span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span>
    <span class="k">if</span> <span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">middle</span> <span class="o">:=</span> <span class="nx">length</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">left</span>

    <span class="nx">left1</span><span class="p">,</span> <span class="nx">right1</span> <span class="o">:=</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">middle</span>
    <span class="nx">left2</span><span class="p">,</span> <span class="nx">right2</span> <span class="o">:=</span> <span class="nx">middle</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">right</span>

    <span class="nx">intMergeSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">left1</span><span class="p">,</span> <span class="nx">right1</span><span class="p">)</span>
    <span class="nx">intMergeSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">left2</span><span class="p">,</span> <span class="nx">right2</span><span class="p">)</span>

    <span class="nx">index</span> <span class="o">:=</span> <span class="nx">left</span>
    <span class="k">for</span> <span class="nx">left1</span> <span class="o">&lt;=</span> <span class="nx">right1</span> <span class="o">&amp;&amp;</span> <span class="nx">left2</span> <span class="o">&lt;=</span> <span class="nx">right2</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left1</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left2</span><span class="p">]</span> <span class="p">{</span>
            <span class="nx">cache</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left1</span><span class="p">]</span>
            <span class="nx">left1</span><span class="o">++</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">cache</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left2</span><span class="p">]</span>
            <span class="nx">left2</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="nx">index</span><span class="o">++</span>

    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">left1</span> <span class="o">&lt;=</span> <span class="nx">right1</span> <span class="p">{</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left1</span><span class="p">]</span>
        <span class="nx">left1</span><span class="o">++</span>
        <span class="nx">index</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">left2</span> <span class="o">&lt;=</span> <span class="nx">right2</span> <span class="p">{</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">left2</span><span class="p">]</span>
        <span class="nx">left2</span><span class="o">++</span>
        <span class="nx">index</span><span class="o">++</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">left</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">right</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">slice</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">slice</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">}</span>
    <span class="nx">IntMergeSort</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h5>4. 排序之插入排序</h5>
<p><img alt="insertion sort" src="https://7xsw69.com1.z0.glb.clouddn.com/Insertion-sort-example-300px.gif" /></p>
<p>如上图所示，插入排序的过程很简单: 遍历后边的无序数字，将他们插入前边已经排好序的序列中。插入方式就是取出数字后，按照从后往前的顺序跟前面有序序列中的数字比较，如果大于等于它，就把这些数字向后移一位，直到找到比它小的(或者超出边界), 然后将该数字插入到该位置。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">sort</span>

<span class="kd">func</span> <span class="nx">IntInsertionSort</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">right</span><span class="o">-</span><span class="nx">left</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">left</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">right</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">temp</span> <span class="o">:=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

        <span class="nx">j</span> <span class="o">:=</span> <span class="nx">i</span>
        <span class="k">for</span> <span class="p">;</span> <span class="nx">j</span> <span class="p">&gt;</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">temp</span> <span class="p">&lt;</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="nx">j</span><span class="o">--</span> <span class="p">{</span>
            <span class="nx">slice</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">slice</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">temp</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/go.html">#Go</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">六 30 四月 2016 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/jian-dan-de-acfunzi-dong-qian-dao.html" rel="bookmark" title="Permalink to 简单的Acfun自动签到">
                        简单的Acfun自动签到
                    </a>
                </h2></header>

                   <div class="clearboth"><p><img alt="acfun" src="https://7xsw69.com1.z0.glb.clouddn.com/acfun.jpg" /></p>
<h3>1.概述</h3>
<p>Acfun有一个签到机制，每天签到可以领取经验和香蕉。之前在玩supervisor，celerybeat和rabbitmq的时候搞了一个自动签到的定时任务，但是由于服务器的原因，每天都会出问题。而且前段时间，那台服务器也到期了，所以现在有必要再搞一个简单的自动签到任务了。：）</p>
<h3>2. 签到</h3>
<p>为了简便，这里就不使用Python了。直接curl搞定吧！上代码：</p>
<div class="highlight"><pre><span></span>curl --cookie-jar cookies -d <span class="s2">&quot;username=name&amp;password=passwd&quot;</span> https://www.acfun.tv/login.aspx <span class="o">&amp;&amp;</span> <span class="nb">echo</span>
curl --cookie cookies -d <span class="s2">&quot;channel=0&amp;date=`date +%s`000&quot;</span> https://www.acfun.tv/webapi/record/actions/signin <span class="o">&amp;&amp;</span> <span class="nb">echo</span>
</pre></div>


<p>简单说明一下， A站签到要求先登录，所以我们脚本的第一步使用自己的账户密码登录并且把cookie存放在本地文件中。然后第二步直接读取cookie完成签到。其实问题就在于签到请求需要带有date参数，它其实是JavaScript的时间戳。将上述代码保存为 <strong>checkin.sh</strong> 就基本上完成了代码部分。是不是很简单？</p>
<h3>3. 自动化</h3>
<p>使用linux的crontab来完成定时任务。在*nix下为当前用户添加一个crontab任务吧。</p>
<ol>
<li>开始编辑 <code>crontab -e</code></li>
<li>添加一行 <code>0 1 * * * sh /path/to/checkin.sh &gt; /path/to/checkin.log</code></li>
<li>保存退出</li>
</ol>
<p>这样就会在每天一点的时候执行一次签到。：）</p>
<h2>4. 结束</h2>
<p>哎，感觉好水啊！</p></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/contab.html">#contab</a>,                             <a href="https://importcjj.github.io/tag/curl.html">#curl</a> and                             <a href="https://importcjj.github.io/tag/shell.html">#shell</a></p>
                    </div>

            </div>
        </article>
        <article class="entry-overview">
            <div class="date">二 26 四月 2016 by <a rel="author" href="https://importcjj.github.io/pages/aboutme.html">importcjj</a></div>
            <div class="detail">
                <header><h2>
                    <a href="https://importcjj.github.io/pythondan-li-mo-shi-de-shi-xian.html" rel="bookmark" title="Permalink to Python单例模式的实现">
                        Python单例模式的实现
                    </a>
                </h2></header>

                   <div class="clearboth"><h4>由于实现的方式很多，先来3种。</h4>
<h4>1. 类实例实现的单例装饰器</h4>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">wrapper</span>

<span class="n">singleton</span> <span class="o">=</span> <span class="n">Singleton</span><span class="p">()</span>

<span class="c1"># 用法</span>
<span class="nd">@singleton</span>
<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span>

<span class="c1"># 这种方式有一个缺点，就是Test这个类会变成一个function, </span>
<span class="c1"># 这样的话就无法使用instance等方式了。</span>
</pre></div>


<h4>2. 类实现的单例装饰器</h4>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_instance</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_instance</span>

<span class="nd">@Singleton</span>
<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">Test</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span>

<span class="c1"># 这种方式Test其实已经是single的一个实例了</span>
<span class="c1"># 缺点和第一种方式一样，Test已经不是原来的Test了</span>
<span class="c1"># 而t1, t2却还是原来的Test的实例</span>
<span class="c1"># 对于这种方式我还存有疑虑，但是又说不出来</span>
<span class="c1"># 总感觉怪怪的</span>
</pre></div>


<h4>3. metaclass元类</h4>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">__cal__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Singleton</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>

<span class="c1"># py2写法</span>
<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__metaclass__</span> <span class="o">=</span> <span class="n">Singleton</span>

    <span class="k">pass</span>

<span class="c1"># py3写法</span>
<span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">Test</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Test</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t1</span> <span class="o">==</span> <span class="n">t2</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Test</span><span class="p">)</span>

<span class="c1"># 使用元类是最好的，因为Test的行为都没有被改变</span>
<span class="c1"># 所以isinstance, type等函数的调用都没有影响</span>
<span class="c1"># 不过理解起来可能会有一些困难了</span>
<span class="c1"># 因为我觉得自己理解的还有一些不够通透</span>
</pre></div></div>

                    <div class="tags">
                        <p>This entry was tagged on  
                            <a href="https://importcjj.github.io/tag/singleton.html">#singleton</a> and                             <a href="https://importcjj.github.io/tag/zhuang-shi-qi.html">#装饰器</a></p>
                    </div>

            </div>
        </article>
<p class="paginator">
    Page 1 / 3
        <a href="https://importcjj.github.io/author/importcjj2.html">&raquo;</a>
</p>

          </section>
       </div>

       <div id="right-side" class="col-1-12">&nbsp;</div>
       <div id="right-side" class="col-3-12">

<div class="section-container">
   <h3>Blogroll</h3>
   <ul>
      <li><a href="http://chihiro.moe" target="_blank">Slade <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://shenyizhou.github.io" target="_blank">无主之地 <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://yuan0.github.io" target="_blank">Junifer <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://getpelican.com/" target="_blank">Pelican <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://python.org/" target="_blank">Python.org <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2 <i class="fa fa-globe fa-fw"></i></a></li>
      <li><a href="http://dongweiming.github.io/Expert-Python/#1" target="_blank">Expert-python <i class="fa fa-globe fa-fw"></i></a></li>
   </ul>
</div>

<div class="section-container">
   <h3>Social Network</h3>
   <ul>
      <li>
        <a href="#" target="_blank">You can add links in your config file&nbsp;
           <i class="fa fa-globe fa-fw"></i>
        </a>
      </li>
      <li>
        <a href="#" target="_blank">Another social link&nbsp;
           <i class="fa fa-globe fa-fw"></i>
        </a>
      </li>
   </ul>
</div>

<div class="section-container">
   <h3>Categories</h3>
   <ul>
        <li><a href="https://importcjj.github.io/category/centos.html">CentOS <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/docker.html">Docker <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/emacs.html">Emacs <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/git.html">git <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/github.html">github <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/go.html">Go <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/markdown.html">Markdown <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/python.html">Python <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/rust.html">Rust <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/sundry.html">sundry <i class="fa fa-folder-open fa-fw"></i></a></li>
        <li><a href="https://importcjj.github.io/category/tool.html">Tool <i class="fa fa-folder-open fa-fw"></i></a></li>
   </ul>
</div>

<div class="section-container">
   <h3>Tags</h3>
   <ul class="tagcloud">
   </ul>
</div>



          <div class="section-container" id="copyright">
             <p>This Blog generated by <a href="https://getpelican.com/">Pelican</a> using <a href="https://github.com/habibillah/pujangga">Pujangga</a> theme. All content on this blog, unless stated otherwise, is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0 International license</a>.</p>
          </div>
       </div>
    </div>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-147239472-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
 

    <script type="text/javascript" src="https://importcjj.github.io/theme/js/hyphenator.js"></script>
    <script type="text/javascript">
      Hyphenator.config({
          donthyphenateclassname: 'docutils',
          useCSS3hyphenation: true
      });
      Hyphenator.run();
    </script>

</body>

</html>