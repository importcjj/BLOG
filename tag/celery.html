<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Signal - celery</title>
        <link rel="stylesheet" href="https://importcjj.github.io/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="https://github.com/importcjj">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="https://importcjj.github.io/">Signal </a></h1>
                <nav><ul>
                    <li><a href="https://importcjj.github.io/category/centos.html">CentOS</a></li>
                    <li><a href="https://importcjj.github.io/category/docker.html">Docker</a></li>
                    <li><a href="https://importcjj.github.io/category/emacs.html">Emacs</a></li>
                    <li><a href="https://importcjj.github.io/category/git.html">git</a></li>
                    <li><a href="https://importcjj.github.io/category/github.html">github</a></li>
                    <li><a href="https://importcjj.github.io/category/go.html">Go</a></li>
                    <li><a href="https://importcjj.github.io/category/markdown.html">Markdown</a></li>
                    <li><a href="https://importcjj.github.io/category/python.html">Python</a></li>
                    <li><a href="https://importcjj.github.io/category/rust.html">Rust</a></li>
                    <li><a href="https://importcjj.github.io/category/sundry.html">sundry</a></li>
                    <li><a href="https://importcjj.github.io/category/tool.html">Tool</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://importcjj.github.io/supervisorcelerycelerybeatde-jian-dan-shi-yong.html">supervisor+celery+celerybeat的简单使用</a></h1>
<footer class="post-info">
        <span>日 27 三月 2016</span>
<span>| tags: <a href="https://importcjj.github.io/tag/supervisor.html">supervisor</a><a href="https://importcjj.github.io/tag/celery.html">celery</a><a href="https://importcjj.github.io/tag/python.html">Python</a></span>
</footer><!-- /.post-info --><h2>1. 提前准备</h2>
<p>略去相关工具的安装过程，其实都挺简单的!</p>
<p>celery作为异步任务队列, 需要一个中间人来协助celery存放和消耗任务信息。我们选择rabbitmq来做消息代理人。使用celery之前, 需要使用创建一个rabbitmq的管理员账号和一个能让该账号访问的vhost.</p>
<p><strong><a href="">Rabbitmq的安装配置以及网页管理插件</a></strong></p>
<p>假设准备的rabbitmq的信息如下:</p>
<div class="highlight"><pre><span></span><span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;www-data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;www-data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;5672&#39;</span><span class="p">,</span>
    <span class="s1">&#39;vhost&#39;</span><span class="p">:</span> <span class="s1">&#39;t_celery&#39;</span>
<span class="p">}</span>
</pre></div>


<h3>示例项目结构</h3>
<div class="highlight"><pre><span></span><span class="n">test</span><span class="p">.</span><span class="n">celery</span><span class="o">/</span>
    <span class="o">|-</span> <span class="n">env</span><span class="o">/</span>
    <span class="o">|-</span> <span class="n">src</span><span class="o">/</span>
        <span class="o">|-</span> <span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
        <span class="o">|-</span> <span class="n">app</span><span class="p">.</span><span class="n">py</span>
        <span class="o">|-</span> <span class="n">task</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<h2>2. celery实例及任务</h2>
<h3>2.1 生成实例</h3>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># filename: app.py</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">CELERY_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CELERY_TIMEZONE&#39;</span><span class="p">:</span> <span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_ENABLE_UTC&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="c1"># content</span>
    <span class="s1">&#39;CELERY_TASK_SERIALIZER&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_RESULT_SERIALIZER&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_ACCEPT_CONTENT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">],</span>
    <span class="s1">&#39;CELERYD_MAX_TASKS_PER_CHILD&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># 第一个参数是实例的名称,  也可以使用模块的名字.</span>
<span class="c1"># broker参数是消息代理人url.</span>
<span class="c1"># 还有一个backend参数，当我们需要拿到异步任务的返回时需要用到.</span>
<span class="c1"># 这里就直接略过了.</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
    <span class="s1">&#39;test_celery&#39;</span><span class="p">,</span>
    <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://{user}:{password}@{host}:{port}/{vhost}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="o">**</span><span class="n">SETTINGS</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">CELERY_CONFIG</span><span class="p">)</span>
</pre></div>


<h3>2.2 定义Task</h3>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># filename: task.py</span>

<span class="kn">from</span> <span class="nn">src.app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;test_celey_queue&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>


<p>注意, 我们给app.task这个装饰器传了queue这个参数, 这样当异步执行的时候,这个task会被丢到名称为test_celery_queue的队列中, 然后被为这个队列工作的worker拿到并执行。当然， 我们也可以在CELERY_CONFIG中配置:</p>
<div class="highlight"><pre><span></span><span class="n">CELERY_ROUTES</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s1">&#39;src.task.add&#39;</span><span class="p">:</span> <span class="s1">&#39;test_celery_queue&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>如果我们不指定queue的话，celery会默认自己指定一个队列。task的队列一定要对应的worke， 否者就会只生产不消费， 这些task就永远不会被执行了。</p>
<h3>2.3 启动worker</h3>
<p>我们需要在项目路径下，也就是test.celery文件下运行python解释器， 否者python解释器无法找到 <strong>src</strong> 这个包。 或者直接将项目路径添加到PYTHONPATH变量，就像这样<code>export PYTHONPATH=/data/test.celery</code></p>
<p>然后再启动worker：</p>
<div class="highlight"><pre><span></span>celery worker -A src.task --loglevel<span class="o">=</span>info -Q test_celery_queue -f /data/test.celery/celery.log
</pre></div>


<h5>参数解析</h5>
<ol>
<li>
<ul>
<li>A src.task 指定celery实例, celery会到src.task中找app实例</li>
</ul>
</li>
<li>worker 告知celery要启动worker.</li>
<li>--loglevel=info 日志的级别是info.</li>
<li>-Q test_celery_queue 为该worker指定一个消息队列, worker只取该队列中的任务。可以指定多个队列.</li>
<li>-f 日志文件输出位置</li>
<li>-P</li>
</ol>
<p>更多可配置参数s通过 <code>celery worker -h</code>  查看。</p>
<h3>2.4 验证正确性</h3>
<h5>在一个终端显示日志</h5>
<div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">celery</span><span class="o">/</span><span class="n">celery</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<h5>另一个终端启动python的交互解释器</h5>
<h6>注：如果没有设置PYTHONPATH， 那就要在我们的项目文件夹下启动</h6>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">src.task</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">AsyncResult</span><span class="p">:</span> <span class="n">fe9b4b75</span><span class="o">-</span><span class="mi">6</span><span class="n">ba8</span><span class="o">-</span><span class="mi">44</span><span class="n">aa</span><span class="o">-</span><span class="n">adb2</span><span class="o">-</span><span class="mi">92</span><span class="n">d63c8ba1c6</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">AsyncResult</span><span class="p">:</span> <span class="n">e6dfcdbb</span><span class="o">-</span><span class="mi">7</span><span class="n">a19</span><span class="o">-</span><span class="mi">4</span><span class="n">fb2</span><span class="o">-</span><span class="n">aa5e</span><span class="o">-</span><span class="mi">841</span><span class="n">b8f393874</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="o">&lt;</span><span class="n">AsyncResult</span><span class="p">:</span> <span class="mi">34</span><span class="n">cf6a59</span><span class="o">-</span><span class="mi">35</span><span class="n">db</span><span class="o">-</span><span class="mi">40</span><span class="n">d3</span><span class="o">-</span><span class="n">a218</span><span class="o">-</span><span class="mi">6703</span><span class="n">eb04336b</span><span class="o">&gt;</span>
</pre></div>


<p>如果一切正常的话，运行第二、三、四条命令的时候会看到有日志输出。而且第二条命令会有错误日志，提示缺少参数。</p>
<h5>用法说明</h5>
<p>如果直接调用某一个task, 那么该task就跟普通的函数一样, 会同步运行并直接返回结果。想要异步执行, 就要使用 <strong>delay</strong> 或者 <strong>apply_async</strong> 。</p>
<ul>
<li><strong>delay:</strong> 相对简单，怎么给<strong>add</strong>传参，就怎么传给它。比如:</li>
</ul>
<p><code>add.delay(4, 5, 9)</code> 或者 <code>add.delay(4 , 5, c=19)</code>等. </p>
<ul>
<li><strong>apply_async:</strong> 列举几个常用的参数:</li>
</ul>
<div class="highlight"><pre><span></span>  <span class="o">*</span> <span class="n">args</span><span class="p">:</span> <span class="err">传给</span><span class="n">task</span><span class="err">的参数</span><span class="p">.</span>
  <span class="o">*</span> <span class="n">kwargs</span><span class="p">:</span> <span class="err">传给</span><span class="n">task</span><span class="err">的参数</span><span class="p">.</span>
  <span class="o">*</span> <span class="n">countdown</span><span class="err">：</span> <span class="err">延时执行的秒数</span><span class="p">.</span><span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="err">表示</span><span class="mi">10</span><span class="n">s</span><span class="err">后执行</span><span class="p">.</span>
  <span class="o">*</span> <span class="n">eta</span><span class="p">:</span> <span class="n">datetime</span><span class="err">类型</span><span class="p">,</span> <span class="err">执行的日期</span><span class="p">.</span>
  <span class="o">*</span> <span class="n">queue</span><span class="p">:</span> <span class="err">指定任务消息要去的队列</span><span class="p">.</span>
  <span class="o">*</span> <span class="p">...</span>
</pre></div>


<h2>3. celery beat</h2>
<p>我们以定时发邮件为例子</p>
<h3>3.1 添加发邮件的task</h3>
<p>在task.py的基础上修改:</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">src.app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">posts</span> <span class="kn">import</span> <span class="n">Posts</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;test_celery_queue&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">c</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">sendmail</span><span class="p">():</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Posts</span><span class="p">(</span><span class="s1">&#39;smtp.qq.com&#39;</span><span class="p">,</span> <span class="s1">&#39;emailname@qq.com&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">465</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">post</span><span class="p">(</span><span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">mail</span><span class="p">:</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">recipient</span> <span class="o">=</span><span class="s1">&#39;receive@163.com,</span>
            <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;send by celery beat&#39;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>
        <span class="p">)</span>
</pre></div>


<p>由于Python标准库发邮件有点繁琐，我这里使用了自己简单封装的<a href="https://github.com/importcjj/Posts">posts</a>来发送邮件。邮件的内容就是执行任务的时间。</p>
<h3>3.2 配置定时任务的schedule</h3>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">CELERYBEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;send-email-every-30-minutes&#39;</span><span class="p">:</span> <span class="p">{</span>    <span class="c1"># 定时任务的名字</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;src.task.sendmail&#39;</span><span class="p">,</span>     <span class="c1"># 具体对应的Task</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span>  <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span><span class="c1"># 定时设置，这里表示30s执行一次</span>
        <span class="c1"># &#39;args&#39;: () ,       # 传给Task的参数</span>
        <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="p">{</span>     <span class="c1"># 设置Task的一些属性, 参见apply_async的参数</span>
            <span class="s1">&#39;queue&#39;</span><span class="p">:</span><span class="s1">&#39;test_celery_queue&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">CELERY_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;CELERY_TIMEZONE&#39;</span><span class="p">:</span> <span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_ENABLE_UTC&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="c1"># content</span>
    <span class="s1">&#39;CELERY_TASK_SERIALIZER&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_RESULT_SERIALIZER&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CELERY_ACCEPT_CONTENT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">],</span>
    <span class="s1">&#39;CELERYD_MAX_TASKS_PER_CHILD&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;CELERYBEAT_SCHEDULE&#39;</span><span class="p">:</span> <span class="n">CELERYBEAT_SCHEDULE</span>     <span class="c1"># 启动beat，传入相关参数.</span>
<span class="p">}</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;www-data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;www-data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;5672&#39;</span><span class="p">,</span>
    <span class="s1">&#39;vhost&#39;</span><span class="p">:</span> <span class="s1">&#39;t_celery&#39;</span>
<span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
    <span class="s1">&#39;test_celery&#39;</span><span class="p">,</span>
    <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://{user}:{password}@{host}:{port}/{vhost}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="o">**</span><span class="n">SETTINGS</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">CELERY_CONFIG</span><span class="p">)</span>
</pre></div>


<p>参数 <strong>schedule</strong> 说明, 通常使用两种方式来指定：</p>
<ol>
<li>datetime.timedelta: 用这种方式来指定 秒 级别.</li>
<li>celery.shedules.crontab: 用这种方式指定 分钟 以上级别.</li>
</ol>
<table>
<thead>
<tr>
<th>Example</th>
<th>表示</th>
</tr>
</thead>
<tbody>
<tr>
<td>timedelta(seconds=30)</td>
<td>30秒执行一次</td>
</tr>
<tr>
<td>crontab()</td>
<td>每分钟执行一次</td>
</tr>
<tr>
<td>crontab(minute=0, hour=0)</td>
<td>凌晨执行一次</td>
</tr>
<tr>
<td>crontab(minute=0, hour='*/3')</td>
<td>从凌晨开始。每三个小时执行一次</td>
</tr>
<tr>
<td>crontab(minute=0,hour='0,3,6,9,12,15,18,21')</td>
<td>同上</td>
</tr>
<tr>
<td>crontab(minute='*/15')</td>
<td>每15分钟执行一次</td>
</tr>
<tr>
<td>crontab(day_of_week='sunday')</td>
<td>在周日，每分钟执行一次</td>
</tr>
<tr>
<td>crontab(minute='<em>',hour='</em>', day_of_week='sun')</td>
<td>同上</td>
</tr>
<tr>
<td>crontab(minute=0, hour='*/5')</td>
<td>每5小时执行一次,0,5,10,15,20</td>
</tr>
<tr>
<td>crontab(0, 0, day_of_month='2')</td>
<td>每个月第二天执行一次</td>
</tr>
<tr>
<td>crontab(0, 0, day_of_month='1-7,15-21')</td>
<td>每月的1-7号和15-21号执行</td>
</tr>
<tr>
<td>crontab(0, 0, day_of_month='11', month_of_year='5')</td>
<td>5月份的11号执行一次</td>
</tr>
<tr>
<td>crontab(0, 0,month_of_year='*/3')</td>
<td>每个季度的第一个月执行一次</td>
</tr>
</tbody>
</table>
<p>更多用法详见 <strong><a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html#crontab-schedules">官方文档</a></strong></p>
<h3>3.3 启动celery beat</h3>
<div class="highlight"><pre><span></span>celery beat -A src.app --loglevel<span class="o">=</span>info --logfile<span class="o">=</span>/data/test.celery/celery.beat.log
</pre></div>


<p>更多可配置参数通过 <code>celery beat -h</code>  查看。</p>
<h3>3.4 验证正确性</h3>
<h5>一个页面显示celery beat 的输入日志</h5>
<div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">celery</span><span class="o">/</span><span class="n">celery</span><span class="p">.</span><span class="n">beat</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<h5>一个终端页面显示 celery worker 输出日志</h5>
<div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">celery</span><span class="o">/</span><span class="n">celery</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>如果分别能看到产生和消耗任务的日志输出。那就成功了。</p>
<h2>4. supervisor</h2>
<h3>4.1 (supervisord)配置并启动supervisor</h3>
<p>启动supervisor的命令是 <strong>supervisord</strong>。我们可以使用 <strong>-c</strong> 参数来指定其配置文件的位置。比如:</p>
<p><code>supervisord -c supervisord.conf</code></p>
<p>supervisor的配置文件 supervisord.conf:</p>
<div class="highlight"><pre><span></span><span class="k">[unix_http_server]</span>
<span class="na">file</span><span class="o">=</span><span class="s">/var/run/supervisor.sock                   ; (the path to the socket file)</span>

<span class="k">[supervisord]</span>
<span class="na">logfile</span><span class="o">=</span><span class="s">/data/log/supervisor/syslog         ; (main log file;default $CWD/supervisord.log)</span>
<span class="na">loglevel</span><span class="o">=</span><span class="s">info                               ; (log level;default info; others: debug,warn,trace)</span>
<span class="na">pidfile</span><span class="o">=</span><span class="s">/var/run/supervisord.pid                ; (supervisord pidfile;default supervisord.pid)</span>
<span class="na">nodaemon</span><span class="o">=</span><span class="s">false                              ; (start in foreground if true;default false)</span>
<span class="na">minfds</span><span class="o">=</span><span class="s">1024                               ; (min. avail startup file descriptors;default 1024)</span>
<span class="na">minprocs</span><span class="o">=</span><span class="s">1024                             ; (min. avail process descriptors;default 200)</span>
<span class="na">nocleanup</span><span class="o">=</span><span class="s">false</span>
<span class="na">umask</span><span class="o">=</span><span class="s">022</span>
<span class="na">user</span><span class="o">=</span><span class="s">root</span>

<span class="k">[supervisorctl]</span>
<span class="na">serverurl</span><span class="o">=</span><span class="s">unix:///var/run/supervisor.sock   ; use a unix:// URL  for a unix socket</span>

<span class="k">[rpcinterface:supervisor]</span>
<span class="na">supervisor.rpcinterface_factory</span> <span class="o">=</span> <span class="s">supervisor.rpcinterface:make_main_rpcinterface</span>

<span class="k">[include]</span>
<span class="na">files</span> <span class="o">=</span> <span class="s">/etc/supervisord.d/*.ini</span>
</pre></div>


<h3>4.2 配置具体项目</h3>
<p>我们会为不同的程序编写独立的ini配置文件，然后放置到一个统一的路径(比如 /etc/supervisord.d/)下让supervisor读取.具体项目的配置文件 test.celery.ini 如下</p>
<div class="highlight"><pre><span></span><span class="k">[group:test_celery]</span>
<span class="na">programs</span> <span class="o">=</span> <span class="s">test_celery.async,test_celery.beat</span>

<span class="k">[program:test_celery.async]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/data/test.celery/env/bin/celery worker -A src.app --loglevel=info -Q test_celery_queue</span>
<span class="na">numprocs</span><span class="o">=</span><span class="s">1</span>
<span class="na">numprocs_start</span><span class="o">=</span><span class="s">0</span>
<span class="na">priority</span><span class="o">=</span><span class="s">999</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">3</span>
<span class="na">startretries</span><span class="o">=</span><span class="s">3</span>
<span class="na">exitcodes</span><span class="o">=</span><span class="s">0,2</span>
<span class="na">stopsignal</span><span class="o">=</span><span class="s">QUIT</span>
<span class="na">stopwaitsecs</span><span class="o">=</span><span class="s">60</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/data/test.celery</span>
<span class="na">user</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">stopasgroup</span><span class="o">=</span><span class="s">false</span>
<span class="na">killasgroup</span><span class="o">=</span><span class="s">false</span>
<span class="na">redirect_stderr</span><span class="o">=</span><span class="s">true</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/data/log/test.celery/test_celery.log</span>
<span class="na">stdout_logfile_maxbytes</span><span class="o">=</span><span class="s">250MB</span>
<span class="na">stdout_logfile_backups</span><span class="o">=</span><span class="s">10</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/data/log/test.celery/test_celery.err</span>
<span class="na">stderr_logfile_maxbytes</span><span class="o">=</span><span class="s">250MB</span>
<span class="na">stderr_logfile_backups</span><span class="o">=</span><span class="s">10</span>
<span class="na">environment</span><span class="o">=</span><span class="s">PYTHONPATH=&#39;/data/test.celery/&#39;;C_FORCE_ROOT=&quot;true&quot;</span>

<span class="k">[program:test_celery.beat]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/data/test.celery/env/bin/celery beat -A src.app --loglevel=info</span>
<span class="na">numprocs</span><span class="o">=</span><span class="s">1</span>
<span class="na">numprocs_start</span><span class="o">=</span><span class="s">0</span>
<span class="na">priority</span><span class="o">=</span><span class="s">999</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">3</span>
<span class="na">startretries</span><span class="o">=</span><span class="s">3</span>
<span class="na">exitcodes</span><span class="o">=</span><span class="s">0,2</span>
<span class="na">stopsignal</span><span class="o">=</span><span class="s">QUIT</span>
<span class="na">stopwaitsecs</span><span class="o">=</span><span class="s">60</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/data/test.celery</span>
<span class="na">user</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">stopasgroup</span><span class="o">=</span><span class="s">false</span>
<span class="na">killasgroup</span><span class="o">=</span><span class="s">false</span>
<span class="na">redirect_stderr</span><span class="o">=</span><span class="s">true</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/data/log/test.celery/test_celery.beat.log</span>
<span class="na">stdout_logfile_maxbytes</span><span class="o">=</span><span class="s">250MB</span>
<span class="na">stdout_logfile_backups</span><span class="o">=</span><span class="s">10</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/data/log/test.celery/test_celery.beat.err</span>
<span class="na">stderr_logfile_maxbytes</span><span class="o">=</span><span class="s">250MB</span>
<span class="na">stderr_logfile_backups</span><span class="o">=</span><span class="s">10</span>
<span class="na">environment</span><span class="o">=</span><span class="s">PYTHONPATH=&#39;/data/test.celery/&#39;;C_FORCE_ROOT=&quot;true&quot;</span>
</pre></div>


<h4>简单说明</h4>
<ul>
<li><strong>test_celery.async</strong> 和 <strong>test_celery.beat</strong> 是两个program，分别对应worker和beat，而它们又同属于 <strong>test_celery</strong> 这个组，这样便于同时管理。</li>
<li>注意到command参数了吗？因为我使用了<strong>virtualenv</strong>来隔离每个项目的包环境，所以需要明确指出 <strong>celery命令</strong>所在的目录(如果全局安装了celery就必要了), 这也是为什么上文项目结构中会有一个 <strong>env</strong> 文件夹的原因。</li>
<li>使用了虚拟环境之后, 通常需要先激活环境 <code>source /data/test.celery/env/bin/activate</code></li>
<li><strong>environment</strong> 下设置 PYTHONPATH 我们在上文中提到过。总之，你要让Python知道你项目包得位置，设置PYTHONPATH 只是一种方式。</li>
</ul>
<h3>4.3 (supervisorctl) 管理程序进程</h3>
<p>通过 <code>sudo supervisorctl</code> 可以进入管理客户端。我们可以使用各种命令管理程序的进程:  </p>
<p>常用的命令有:</p>
<ul>
<li>status \<program-name>  查看状态</li>
<li>restart \<program-name> 重新启动</li>
<li>start \<program-name>    启动</li>
<li>stop \<prorgram-name>   停止</li>
<li>update                                    更新配置</li>
</ul>
<p>也可以不进入来管理 ，例如每次更新玩配置，我们可以使其快速生效:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="k">update</span> 
</pre></div>


<p>​   </p>
<h2>5. 结束语</h2>
<p>上文中只是简单介绍了supervisor 、celery、 celerybeat的简单运用。如果有兴趣的话可以自己去深入了解!</p>
<p><strong>本篇文章到此结束，原创手打！ </strong></p>
<p><strong>人生苦短， 我用python!</strong></p><p><a href="https://importcjj.github.io/supervisorcelerycelerybeatde-jian-dan-shi-yong.html#disqus_thread">comments</a></p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://chihiro.moe">Slade</a></li>
                            <li><a href="http://shenyizhou.github.io">无主之地</a></li>
                            <li><a href="http://yuan0.github.io">Junifer</a></li>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="http://dongweiming.github.io/Expert-Python/#1">Expert-python</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'importcjj';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>